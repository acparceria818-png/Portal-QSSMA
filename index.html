<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Portal QSSMA - Qualidade, Segurança, Saúde e Meio Ambiente">
  <meta name="theme-color" content="#b00000" />
  <title>Portal QSSMA</title>
  
  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="logo.jpg" type="image/jpg">
  
  <!-- CSS -->
  <link rel="stylesheet" href="styles.css">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- JS -->
  <script type="module" src="firebase.js"></script>
  <script type="module" src="app.js"></script>
</head>
<body>

<header>
  <img src="logo.jpg" alt="QSSMA Logo" class="logo" loading="lazy" />
  <h1>PORTAL QSSMA<br><small>Qualidade, Segurança, Saúde e Meio Ambiente</small></h1>
  <div class="user-status" id="userStatus" style="display:none">
    <span id="userName"></span>
    <button class="logout-btn" onclick="logout()" title="Sair">
      <i class="fas fa-sign-out-alt"></i>
    </button>
  </div>
</header>

<div class="top-actions container">
  <div>
    <button class="icon-btn" id="installBtn" style="display:none" aria-label="Instalar aplicativo">
      <i class="fas fa-download"></i> Instalar
    </button>
  </div>
  <div>
    <button class="icon-btn" id="darkToggle" title="Alternar tema" aria-label="Alternar tema claro/escuro">
      <i class="fas fa-moon"></i>
    </button>
    <span class="connection-status" id="connectionStatus" title="Status da conexão">
      <i class="fas fa-circle"></i>
    </span>
    <button class="icon-btn" id="avisosBtn" onclick="mostrarAvisos()">
      <i class="fas fa-bullhorn"></i> Avisos
      <span class="badge" id="avisosCount" style="display:none">0</span>
    </button>
  </div>
</div>

<main class="container">

  <!-- TELA DE BOAS VINDAS -->
  <section id="welcome" class="tela ativa">
    <div class="welcome-content">
      <div class="avatar-large">
        <img src="logo.jpg" class="avatar" alt="Avatar QSSMA" loading="lazy" />
      </div>
      <div class="welcome-text">
        <h2><i class="fas fa-shield-alt"></i> Bem-vindo ao Portal QSSMA</h2>
        <p>Sistema integrado de gestão de Qualidade, Segurança, Saúde e Meio Ambiente</p>
        
        <div class="alert-card">
          <div class="alert-icon">
            <i class="fas fa-exclamation-circle"></i>
          </div>
          <div class="alert-content">
            <strong>Importante:</strong> Todos os formulários devem ser preenchidos com atenção aos detalhes e verificação das informações.
          </div>
        </div>
        
        <button class="btn btn-primary btn-large" onclick="entrarNoPortal()">
          <i class="fas fa-sign-in-alt"></i> Acessar Portal
        </button>
      </div>
    </div>
  </section>

  <!-- TELA: ESCOLHA DE PERFIL -->
  <section id="telaEscolhaPerfil" class="tela hidden">
    <div class="section-header">
      <h2><i class="fas fa-user-circle"></i> Como você está acessando?</h2>
      <p>Selecione seu perfil para continuar</p>
    </div>
    
    <div class="cards-grid">
      <div class="profile-card" onclick="selecionarPerfil('usuario')">
        <div class="card-icon usuario">
          <i class="fas fa-user-check"></i>
        </div>
        <h3>Colaborador</h3>
        <p>Acesso para registro de inspeções e relatórios de segurança</p>
        <div class="card-features">
          <span><i class="fas fa-clipboard-check"></i> Inspeções</span>
          <span><i class="fas fa-file-alt"></i> Relatórios</span>
          <span><i class="fas fa-bell"></i> Avisos</span>
        </div>
      </div>
      
      <div class="profile-card" onclick="selecionarPerfil('gestor')">
        <div class="card-icon gestor">
          <i class="fas fa-user-tie"></i>
        </div>
        <h3>Gestor</h3>
        <p>Painel administrativo para monitoramento e gestão QSSMA</p>
        <div class="card-features">
          <span><i class="fas fa-chart-line"></i> Dashboard</span>
          <span><i class="fas fa-cog"></i> Configurações</span>
          <span><i class="fas fa-shield-alt"></i> Controle</span>
        </div>
      </div>
    </div>
    
    <div class="action-footer">
      <button class="btn btn-secondary" onclick="mostrarTela('welcome')">
        <i class="fas fa-arrow-left"></i> Voltar
      </button>
    </div>
  </section>

  <!-- TELA: LOGIN USUÁRIO -->
  <section id="tela-usuario-login" class="tela hidden">
    <div class="section-header">
      <h2><i class="fas fa-user-check"></i> Acesso do Colaborador</h2>
      <p>Informe sua matrícula para continuar</p>
    </div>
    
    <div class="auth-card">
      <div class="auth-icon">
        <i class="fas fa-id-card"></i>
      </div>
      
      <div class="form-group">
        <label for="matriculaUsuario">
          <i class="fas fa-hashtag"></i> Matrícula
        </label>
        <input
          id="matriculaUsuario"
          type="text"
          placeholder="Digite sua matrícula"
          class="form-input"
          aria-label="Matrícula do colaborador"
          maxlength="20"
          autocomplete="off"
        />
        <div class="form-hint">
          <i class="fas fa-info-circle"></i> Exemplo: QSSMA12345
        </div>
      </div>
      
      <button class="btn btn-primary btn-block" onclick="loginUsuario()" id="loginUsuarioBtn">
        <i class="fas fa-sign-in-alt"></i> Entrar
      </button>
      
      <div class="auth-footer">
        <p><i class="fas fa-exclamation-triangle"></i> Apenas colaboradores autorizados</p>
      </div>
    </div>
    
    <div class="action-footer">
      <button class="btn btn-secondary" onclick="mostrarTela('telaEscolhaPerfil')">
        <i class="fas fa-arrow-left"></i> Voltar
      </button>
    </div>
  </section>

  <!-- TELA: USUÁRIO AUTENTICADO -->
  <section id="tela-usuario" class="tela hidden">
    <div class="user-header">
      <div class="user-avatar">
        <i class="fas fa-user-circle"></i>
      </div>
      <div class="user-info">
        <h2>Olá, <span id="usuarioNome"></span>!</h2>
        <div class="user-details">
          <span class="user-badge">
            <i class="fas fa-id-card"></i> <span id="usuarioMatricula"></span>
          </span>
          <span class="user-badge">
            <i class="fas fa-building"></i> <span id="usuarioSetor"></span>
          </span>
          <span class="user-badge">
            <i class="fas fa-briefcase"></i> <span id="usuarioFuncao"></span>
          </span>
        </div>
      </div>
    </div>
    
    <div class="cards-grid">
      <div class="feature-card" onclick="abrirFormulario('informe-evento')">
        <div class="card-icon danger">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        <h3>Informe de Evento</h3>
        <p>Registro de incidentes e eventos de segurança</p>
        <small>Formulário obrigatório</small>
      </div>
      
      <div class="feature-card" onclick="abrirFormulario('radar-velocidade')">
        <div class="card-icon warning">
          <i class="fas fa-tachometer-alt"></i>
        </div>
        <h3>Radar Móvel</h3>
        <p>Registro de controle de velocidade</p>
        <small>Monitoramento preventivo</small>
      </div>
      
      <div class="feature-card" onclick="abrirFormulario('flash-report')">
        <div class="card-icon info">
          <i class="fas fa-bolt"></i>
        </div>
        <h3>Flash Report</h3>
        <p>Relatório rápido de ocorrências</p>
        <small>Comunicação ágil</small>
      </div>
      
      <div class="feature-card" onclick="mostrarAvisos()">
        <div class="card-icon secondary">
          <i class="fas fa-bullhorn"></i>
        </div>
        <h3>Avisos & Comunicados</h3>
        <p>Informações importantes da empresa</p>
        <span class="badge" id="avisosCountUsuario" style="display:none">0</span>
      </div>
      
      <div class="feature-card" onclick="abrirFeedback()">
        <div class="card-icon success">
          <i class="fas fa-comment-dots"></i>
        </div>
        <h3>Sugestões</h3>
        <p>Melhorias para o sistema QSSMA</p>
        <small>Seu feedback é importante</small>
      </div>
      
      <div class="feature-card whatsapp" onclick="abrirSuporteWhatsApp()">
        <div class="card-icon">
          <i class="fab fa-whatsapp"></i>
        </div>
        <h3>Suporte WhatsApp</h3>
        <p>Contato de suporte 24h</p>
        <small>Emergências</small>
      </div>
    </div>
    
    <div class="action-footer">
      <button class="btn btn-secondary" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i> Sair
      </button>
    </div>
  </section>

  <!-- TELA: LOGIN GESTOR -->
  <section id="tela-gestor-login" class="tela hidden">
    <div class="section-header">
      <h2><i class="fas fa-user-tie"></i> Acesso Gestor QSSMA</h2>
      <p>Acesso restrito à equipe de gestão</p>
    </div>
    
    <div class="auth-card">
      <div class="auth-icon gestor">
        <i class="fas fa-shield-alt"></i>
      </div>
      
      <div class="form-group">
        <label for="gestorEmail">
          <i class="fas fa-envelope"></i> E-mail
        </label>
        <input type="email" id="gestorEmail" placeholder="seu@email.com" class="form-input" />
      </div>
      
      <div class="form-group">
        <label for="gestorSenha">
          <i class="fas fa-lock"></i> Senha
        </label>
        <input type="password" id="gestorSenha" placeholder="Sua senha" class="form-input" />
      </div>
      
      <button class="btn btn-primary btn-block" onclick="loginGestor()">
        <i class="fas fa-sign-in-alt"></i> Entrar
      </button>
      
      <div class="auth-footer">
        <p><i class="fas fa-exclamation-circle"></i> Acesso restrito aos gestores autorizados</p>
      </div>
    </div>
    
    <div class="action-footer">
      <button class="btn btn-secondary" onclick="mostrarTela('telaEscolhaPerfil')">
        <i class="fas fa-arrow-left"></i> Voltar
      </button>
    </div>
  </section>

  <!-- TELA: GESTOR DASHBOARD -->
  <section id="tela-gestor-dashboard" class="tela hidden">
    <div class="section-header">
      <h2><i class="fas fa-tachometer-alt"></i> Painel de Gestão QSSMA</h2>
      <p>Dashboard administrativo - Monitoramento em tempo real</p>
    </div>
    
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon primary">
          <i class="fas fa-users"></i>
        </div>
        <div class="stat-content">
          <h3 id="usuariosAtivosCount">0</h3>
          <p>Usuários Ativos</p>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon warning">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="stat-content">
          <h3 id="eventosCount">0</h3>
          <p>Eventos Registrados</p>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon danger">
          <i class="fas fa-tachometer-alt"></i>
        </div>
        <div class="stat-content">
          <h3 id="radaresCount">0</h3>
          <p>Radar de Velocidade</p>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon success">
          <i class="fas fa-file-alt"></i>
        </div>
        <div class="stat-content">
          <h3 id="reportsCount">0</h3>
          <p>Flash Reports</p>
        </div>
      </div>
    </div>
    
    <div class="dashboard-tabs">
      <button class="dashboard-tab active" onclick="mostrarTab('avisos')">
        <i class="fas fa-bullhorn"></i> Gerenciar Avisos
      </button>
      <button class="dashboard-tab" onclick="mostrarTab('usuarios')">
        <i class="fas fa-users"></i> Usuários
      </button>
      <button class="dashboard-tab" onclick="mostrarTab('relatorios')">
        <i class="fas fa-chart-bar"></i> Relatórios
      </button>
      <button class="dashboard-tab" onclick="mostrarTab('configuracoes')">
        <i class="fas fa-cog"></i> Configurações
      </button>
    </div>
    
    <div class="tab-content active" id="tabAvisos">
      <div class="tab-header">
        <h3><i class="fas fa-bullhorn"></i> Gerenciar Avisos</h3>
        <button class="btn btn-success btn-small" onclick="criarNovoAviso()">
          <i class="fas fa-plus"></i> Novo Aviso
        </button>
      </div>
      <div class="avisos-container" id="avisosList">
        <div class="loading-state">
          <i class="fas fa-spinner fa-spin"></i>
          <p>Carregando avisos...</p>
        </div>
      </div>
    </div>
    
    <div class="tab-content" id="tabUsuarios">
      <div class="tab-header">
        <h3><i class="fas fa-users"></i> Gestão de Usuários</h3>
      </div>
      <div class="usuarios-container" id="usuariosList">
        <div class="loading-state">
          <i class="fas fa-spinner fa-spin"></i>
          <p>Carregando usuários...</p>
        </div>
      </div>
    </div>
    
    <div class="tab-content" id="tabRelatorios">
      <div class="tab-header">
        <h3><i class="fas fa-chart-bar"></i> Relatórios QSSMA</h3>
      </div>
      <div class="relatorios-gestao-container" id="relatoriosGestorList">
        <div class="loading-state">
          <i class="fas fa-spinner fa-spin"></i>
          <p>Carregando relatórios...</p>
        </div>
      </div>
    </div>
    
    <div class="tab-content" id="tabConfiguracoes">
      <div class="tab-header">
        <h3><i class="fas fa-cog"></i> Configurações do Sistema</h3>
      </div>
      <div class="configuracoes-container">
        <div class="config-card">
          <h4><i class="fas fa-link"></i> Links dos Formulários</h4>
          <div class="form-group">
            <label>Informe de Evento</label>
            <input type="text" id="urlInformeEvento" class="form-input" 
                   value="https://forms.gle/4kxcxyYX8wzdDyDt5" readonly>
            <button class="btn btn-small" onclick="copiarUrl('urlInformeEvento')">
              <i class="fas fa-copy"></i> Copiar
            </button>
          </div>
          
          <div class="form-group">
            <label>Radar Móvel de Velocidade</label>
            <input type="text" id="urlRadarMovel" class="form-input" 
                   value="https://forms.gle/BZahsh5ZAAVyixjx5" readonly>
            <button class="btn btn-small" onclick="copiarUrl('urlRadarMovel')">
              <i class="fas fa-copy"></i> Copiar
            </button>
          </div>
          
          <div class="form-group">
            <label>Flash Report</label>
            <input type="text" id="urlFlashReport" class="form-input" 
                   value="https://forms.gle/9d6f4w7hcpyDSCCs5" readonly>
            <button class="btn btn-small" onclick="copiarUrl('urlFlashReport')">
              <i class="fas fa-copy"></i> Copiar
            </button>
          </div>
        </div>
        
        <div class="config-card">
          <h4><i class="fas fa-phone"></i> Contatos de Emergência</h4>
          <div class="form-group">
            <label>WhatsApp Suporte</label>
            <input type="text" id="whatsappSuporte" class="form-input" 
                   value="+55 93 9205-9914" readonly>
            <button class="btn btn-small" onclick="copiarUrl('whatsappSuporte')">
              <i class="fas fa-copy"></i> Copiar
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <div class="action-footer">
      <button class="btn btn-secondary" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i> Sair
      </button>
    </div>
  </section>

  <!-- TELA: FEEDBACK -->
  <section id="tela-feedback" class="tela hidden">
    <div class="section-header">
      <h2><i class="fas fa-comment-dots"></i> Feedback & Sugestões</h2>
      <p>Envie sugestões para melhorar o sistema QSSMA</p>
    </div>
    
    <div class="auth-card">
      <div class="form-group">
        <label>Tipo</label>
        <select id="feedbackTipo" class="form-input">
          <option value="sugestao">Sugestão</option>
          <option value="melhoria">Melhoria</option>
          <option value="reclamacao">Reclamação</option>
          <option value="elogio">Elogio</option>
          <option value="problema">Problema Técnico</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Mensagem</label>
        <textarea id="feedbackMensagem" class="form-input" rows="5" 
                  placeholder="Descreva sua mensagem... (mínimo 10 caracteres)"></textarea>
      </div>
      
      <div class="form-actions">
        <button class="btn btn-primary" onclick="enviarFeedback()">
          <i class="fas fa-paper-plane"></i> Enviar
        </button>
        <button class="btn btn-secondary" onclick="mostrarTela('tela-usuario')">
          <i class="fas fa-times"></i> Cancelar
        </button>
      </div>
    </div>
  </section>

</main>

<!-- MODAL DE AVISOS -->
<div id="avisosModal" class="modal-back" aria-hidden="true" style="display:none">
  <div class="modal">
    <button class="close" onclick="closeModal('avisosModal')" aria-label="Fechar">✕</button>
    <h3><i class="fas fa-bullhorn"></i> Avisos Importantes</h3>
    <div class="avisos-list" id="avisosDinamicos">
      <div class="loading-state">
        <i class="fas fa-spinner fa-spin"></i>
        <p>Carregando avisos...</p>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" onclick="closeModal('avisosModal')">Fechar</button>
    </div>
  </div>
</div>

<!-- MODAL NOVO AVISO (GESTOR) -->
<div id="novoAvisoModal" class="modal-back" aria-hidden="true" style="display:none">
  <div class="modal">
    <button class="close" onclick="closeModal('novoAvisoModal')" aria-label="Fechar">✕</button>
    <h3><i class="fas fa-plus"></i> Novo Aviso</h3>
    
    <div class="form-group">
      <label>Título *</label>
      <input type="text" id="novoAvisoTitulo" class="form-input" placeholder="Título do aviso" required>
    </div>
    
    <div class="form-group">
      <label>Mensagem *</label>
      <textarea id="novoAvisoMensagem" class="form-input" rows="4" placeholder="Mensagem do aviso" required></textarea>
    </div>
    
    <div class="form-group">
      <label>Tipo</label>
      <select id="novoAvisoTipo" class="form-input">
        <option value="informativo">Informativo</option>
        <option value="importante">Importante</option>
        <option value="urgente">Urgente</option>
        <option value="emergencia">Emergência</option>
      </select>
    </div>
    
    <div class="form-group">
      <label>Destino</label>
      <select id="novoAvisoDestino" class="form-input">
        <option value="todos">Todos os usuários</option>
        <option value="gestores">Apenas gestores</option>
        <option value="colaboradores">Apenas colaboradores</option>
      </select>
    </div>
    
    <div class="form-group">
      <label>
        <input type="checkbox" id="novoAvisoAtivo" checked> Aviso ativo
      </label>
    </div>
    
    <div class="form-actions">
      <button class="btn btn-primary" onclick="salvarNovoAviso()">
        <i class="fas fa-save"></i> Salvar Aviso
      </button>
      <button class="btn btn-secondary" onclick="closeModal('novoAvisoModal')">
        <i class="fas fa-times"></i> Cancelar
      </button>
    </div>
  </div>
</div>

<!-- LOADING OVERLAY -->
<div id="loadingOverlay" class="loading-overlay" style="display:none">
  <div class="loading-content">
    <div class="loading-spinner"></div>
    <p id="loadingText">Carregando...</p>
  </div>
</div>

<!-- OFFLINE BANNER -->
<div id="offlineBanner" class="offline-banner" style="display:none">
  <i class="fas fa-wifi-slash"></i>
  <span>Você está offline. Algumas funcionalidades podem não estar disponíveis.</span>
</div>

<script>
  // Função para alternar entre tabs no gestor
  function mostrarTab(tabId) {
    // Esconder todas as tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
      tab.classList.remove('active');
    });
    
    // Remover active de todos os botões
    document.querySelectorAll('.dashboard-tab').forEach(btn => {
      btn.classList.remove('active');
    });
    
    // Mostrar tab selecionada
    const tabElement = document.getElementById(`tab${tabId.charAt(0).toUpperCase() + tabId.slice(1)}`);
    if (tabElement) {
      tabElement.classList.add('active');
    }
    
    // Ativar botão correspondente
    if (event && event.target) {
      event.target.classList.add('active');
    }
  }
  
  // Função para copiar URL
  window.copiarUrl = function(inputId) {
    const input = document.getElementById(inputId);
    input.select();
    input.setSelectionRange(0, 99999);
    document.execCommand('copy');
    
    mostrarNotificacao('✅ Copiado', 'URL copiada para a área de transferência');
  };
  
  // Funções de modal
  window.closeModal = function(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.style.display = 'none';
    }
  };
  
  window.openModal = function(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.style.display = 'flex';
    }
  };
</script>
</body>
</html>
